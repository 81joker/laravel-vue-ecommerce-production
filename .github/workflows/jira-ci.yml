# Ù…Ù„Ù: .github/workflows/jira-ci.yml
name: Jira Integrated CI/CD

on:
  push:
    branches: ["main", "develop", "feature/*", "LVEP-*"]
  pull_request:
    branches: ["main"]

env:
  JIRA_BASE_URL: "https://nehadaltimimi.atlassian.net"
  JIRA_PROJECT_KEY: "LVEP"

jobs:
  detect-issue:
    runs-on: ubuntu-latest
    outputs:
      issue_key: ${{ steps.extract.outputs.issue_key }}

    steps:
      - name: Extract Jira Issue Key
        id: extract
        run: |
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ LVEP-2 Ù…Ù† Ø£ÙŠ ÙØ±Ø¹
          BRANCH_NAME="${{ github.ref_name }}"
          echo "Branch name: $BRANCH_NAME"

          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† LVEP-Ø±Ù‚Ù…
          if [[ "$BRANCH_NAME" =~ (LVEP-[0-9]+) ]]; then
            ISSUE_KEY="${BASH_REMATCH[1]}"
            echo "âœ… Found Jira issue: $ISSUE_KEY"
            echo "issue_key=$ISSUE_KEY" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH_NAME" =~ ([A-Z]+-[0-9]+) ]]; then
            ISSUE_KEY="${BASH_REMATCH[1]}"
            echo "âœ… Found Jira issue (other project): $ISSUE_KEY"
            echo "issue_key=$ISSUE_KEY" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ No Jira issue pattern found in branch name"
            echo "â„¹ï¸ To link to Jira, use branch names like: LVEP-2-description"
          fi

  build-and-test:
    runs-on: ubuntu-latest
    needs: detect-issue

    steps:
      - uses: actions/checkout@v4

      # ØªØ­Ø¯ÙŠØ« Jira ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ issue
      - name: Update Jira Status to In Progress
        if: needs.detect-issue.outputs.issue_key != ''
        run: |
          echo "ğŸ“¤ Updating Jira issue: ${{ needs.detect-issue.outputs.issue_key }}"

          # Ø§Ø³ØªØ®Ø¯Ø§Ù… curl Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ§Ù…Ù„
          curl -X POST \
            -H "Authorization: Basic $(echo -n '${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64)" \
            -H "Content-Type: application/json" \
            "${{ env.JIRA_BASE_URL }}/rest/api/3/issue/${{ needs.detect-issue.outputs.issue_key }}/transitions" \
            -d '{
              "transition": {
                "id": "11"  # âš ï¸ ØªØ­ØªØ§Ø¬ Ù„ØªØºÙŠÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…
              }
            }'
        continue-on-error: true # Ù„Ø§ ØªÙˆÙ‚Ù Ø§Ù„Ù€ pipeline Ø¥Ø°Ø§ ÙØ´Ù„

      # ... Ø¨Ø§Ù‚ÙŠ Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªÙŠ Ù„Ø¯ÙŠÙƒ ...

      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"

      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Prepare environment
        run: |
          cp .env.example .env
          php artisan key:generate
          mkdir -p database
          touch database/database.sqlite

      # ØªØ¹Ù„ÙŠÙ‚ ÙÙŠ Jira Ø¹Ù†Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¨Ù†Ø§Ø¡
      - name: Add Success Comment to Jira
        if: success() && needs.detect-issue.outputs.issue_key != ''
        run: |
          curl -X POST \
            -H "Authorization: Basic $(echo -n '${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64)" \
            -H "Content-Type: application/json" \
            "${{ env.JIRA_BASE_URL }}/rest/api/3/issue/${{ needs.detect-issue.outputs.issue_key }}/comment" \
            -d '{
              "body": {
                "type": "doc",
                "version": 1,
                "content": [
                  {
                    "type": "paragraph",
                    "content": [
                      {
                        "type": "text",
                        "text": "âœ… CI/CD Pipeline completed successfully!",
                        "marks": [
                          {
                            "type": "strong"
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "type": "paragraph",
                    "content": [
                      {
                        "type": "text",
                        "text": "Build details: "
                      },
                      {
                        "type": "text",
                        "text": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                        "marks": [
                          {
                            "type": "link",
                            "attrs": {
                              "href": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                            }
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            }'
