name: Laravel Vue CI/CD with Jira

on:
    push:
        branches: ["main", "develop", "feature/*"]
    pull_request:
        branches: ["main"]

env:
    JIRA_BASE_URL: "https://nehadaltimimi.atlassian.net"
    JIRA_PROJECT_KEY: "LVEP"

jobs:
    # ======================
    # 1. Ø§ÙƒØªØ´Ø§Ù Jira Issue
    # ======================
    detect-jira-issue:
        runs-on: ubuntu-latest
        outputs:
            issue_key: ${{ steps.extract.outputs.issue_key }}

        steps:
            - name: Extract Jira Issue from branch name
              id: extract
              run: |
                  # Ù‡Ø°Ø§ ÙŠØ³ØªØ®Ø±Ø¬ LVEP-2 Ù…Ù† "feature/LVEP-2-clean-route"
                  # Ø£Ùˆ "LVEP-2-clean-route" Ø£Ùˆ "LVEP-2"
                  BRANCH_NAME="${{ github.ref_name }}"

                  # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù†Ù…Ø· Jira Issue (Ù…Ø«Ù„ LVEP-2)
                  if [[ "$BRANCH_NAME" =~ ([A-Z]+-[0-9]+) ]]; then
                    ISSUE_KEY="${BASH_REMATCH[1]}"
                    echo "issue_key=$ISSUE_KEY" >> $GITHUB_OUTPUT
                    echo "âœ… Found Jira issue: $ISSUE_KEY"
                  else
                    echo "â„¹ï¸ No Jira issue found in branch: $BRANCH_NAME"
                  fi

    # ======================
    # 2. Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ø¹ ØªØ­Ø¯ÙŠØ« Jira
    # ======================
    build:
        runs-on: ubuntu-latest
        needs: detect-jira-issue

        steps:
            - uses: actions/checkout@v4

            # ğŸ“Œ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Jira Ø¥Ù„Ù‰ "In Progress"
            - name: Update Jira status to In Progress
              if: needs.detect-jira-issue.outputs.issue_key != ''
              uses: atlassian/gajira-transition@v3
              with:
                  issue: ${{ needs.detect-jira-issue.outputs.issue_key }}
                  transition: "Start Progress" # Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„
              env:
                  JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
                  JIRA_BASE_URL: ${{ env.JIRA_BASE_URL }}
                  JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}

            # ğŸ“Œ Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚ ÙÙŠ Jira Ø£Ù† Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ø¯Ø£
            - name: Comment on Jira issue (Build started)
              if: needs.detect-jira-issue.outputs.issue_key != ''
              uses: atlassian/gajira-comment@v3
              with:
                  issue: ${{ needs.detect-jira-issue.outputs.issue_key }}
                  comment: |
                      ğŸ”¨ **CI/CD Pipeline Started**

                      **Details:**
                      - Workflow: ${{ github.workflow }}
                      - Branch: ${{ github.ref_name }}
                      - Commit: ${{ github.sha }}
                      - Triggered by: ${{ github.actor }}

                      Build process is now running...
              env:
                  JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
                  JIRA_BASE_URL: ${{ env.JIRA_BASE_URL }}
                  JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}

            # ======================
            # Ø¨Ù†Ø§Ø¡ Laravel & Vue
            # ======================
            - uses: shivammathur/setup-php@v2
              with:
                  php-version: "8.4"
                  extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite
                  coverage: none

            - name: Cache Composer packages
              uses: actions/cache@v3
              with:
                  path: vendor
                  key: ${{ runner.os }}-composer-${{ hashFiles('composer.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-composer-

            - name: Install Composer dependencies
              run: composer install --no-interaction --prefer-dist --no-progress

            # Ø¥Ø¹Ø¯Ø§Ø¯ Node.js Ù„Ù€ Vue
            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "18"
                  cache: "npm"

            - name: Cache node modules
              uses: actions/cache@v3
              with:
                  path: node_modules
                  key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-

            - name: Install Node dependencies
              run: npm ci

            # Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ¦Ø© Laravel
            - name: Prepare Laravel environment
              run: |
                  cp .env.example .env
                  php artisan key:generate
                  mkdir -p database
                  touch database/database.sqlite

            # Ø¨Ù†Ø§Ø¡ Ø£ØµÙˆÙ„ Vue
            - name: Build Vue assets
              run: npm run build

            # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
            # - name: Run PHP tests
            #   run: vendor/bin/phpunit --testdox

            # ğŸ“Œ ØªØ­Ø¯ÙŠØ« Jira Ø¨Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
            - name: Update Jira with test results
              if: always() && needs.detect-jira-issue.outputs.issue_key != ''
              uses: atlassian/gajira-comment@v3
              with:
                  issue: ${{ needs.detect-jira-issue.outputs.issue_key }}
                  comment: |
                      ${{ job.status == 'success' && 'âœ…' || 'âŒ' }} **Tests ${{ job.status == 'success' && 'PASSED' || 'FAILED' }}**

                      **Job Status:** ${{ job.status }}
                      **Build Number:** ${{ github.run_number }}

                      View details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              env:
                  JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
                  JIRA_BASE_URL: ${{ env.JIRA_BASE_URL }}
                  JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}

    # ======================
    # 3. ÙØ­Øµ Ø§Ù„ÙƒÙˆØ¯ (Lint)
    # ======================
    lint:
        runs-on: ubuntu-latest
        needs: [detect-jira-issue, build]

        steps:
            - uses: actions/checkout@v4

            - uses: shivammathur/setup-php@v2
              with:
                  php-version: "8.4"

            - name: Install dependencies
              run: composer install --no-interaction --prefer-dist

            - name: Run Laravel Pint
              run: vendor/bin/pint --test

            # ÙØ­Øµ Vue/JavaScript
            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "18"

            - name: Run ESLint
              run: npx eslint resources/js --ext .vue,.js || echo "ESLint check completed"

            # ğŸ“Œ ØªØ¹Ù„ÙŠÙ‚ ÙÙŠ Jira Ø¹Ù† ÙØ­Øµ Ø§Ù„ÙƒÙˆØ¯
            - name: Comment lint results on Jira
              if: always() && needs.detect-jira-issue.outputs.issue_key != ''
              uses: atlassian/gajira-comment@v3
              with:
                  issue: ${{ needs.detect-jira-issue.outputs.issue_key }}
                  comment: |
                      ğŸ” **Code Quality Check Completed**

                      **PHP Code Style:** ${{ job.status == 'success' && 'âœ… Passed' || 'âŒ Issues found' }}
                      **JavaScript/Vue Code Style:** ESLint check completed

                      Code is ready for review!
              env:
                  JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
                  JIRA_BASE_URL: ${{ env.JIRA_BASE_URL }}
                  JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}

    # ======================
    # 4. Ø§Ù„Ù†Ø´Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    # ======================
    deploy:
        runs-on: ubuntu-latest
        needs: [detect-jira-issue, build, lint]
        if: github.ref == 'refs/heads/main' && success()

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            # ğŸ“Œ ØªØ­Ø¯ÙŠØ« Jira Ø¥Ù„Ù‰ "In Review" Ø£Ùˆ "Done"
            - name: Update Jira status for deployment
              if: needs.detect-jira-issue.outputs.issue_key != ''
              uses: atlassian/gajira-transition@v3
              with:
                  issue: ${{ needs.detect-jira-issue.outputs.issue_key }}
                  transition: "Done" # Ø£Ùˆ "Ready for Review"
              env:
                  JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
                  JIRA_BASE_URL: ${{ env.JIRA_BASE_URL }}
                  JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}

            - name: Deploy to production
              run: |
                  echo "ğŸš€ Deploying to production..."
                  # Ø£Ø¶Ù Ù‡Ù†Ø§ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
                  # Ù…Ø«Ù„: rsync, scp, SSH, etc.

            # ğŸ“Œ ØªØ¹Ù„ÙŠÙ‚ Ù†Ù‡Ø§Ø¦ÙŠ ÙÙŠ Jira
            - name: Final Jira comment after deployment
              if: needs.detect-jira-issue.outputs.issue_key != ''
              uses: atlassian/gajira-comment@v3
              with:
                  issue: ${{ needs.detect-jira-issue.outputs.issue_key }}
                  comment: |
                      ğŸ‰ **Deployment Complete!**

                      **Status:** Successfully deployed to production
                      **Environment:** Production
                      **Deployed At:** ${{ steps.date.outputs.date }}

                      This issue is now complete and ready for verification.
              env:
                  JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
                  JIRA_BASE_URL: ${{ env.JIRA_BASE_URL }}
                  JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
