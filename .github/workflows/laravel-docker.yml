name: Laravel Docker CI

on:
    push:
        branches: ["main"]

jobs:
    # =====================
    # 1. LINT (Code Style)
    # =====================
    lint:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build CI Docker image
              run: docker build -f Dockerfile.ci -t laravel-ci .

            - name: Run Pint (Lint)
              run: |
                  docker run --rm \
                    laravel-ci vendor/bin/pint --test

    # =====================
    # 2. TESTS
    # =====================
    test:
        runs-on: ubuntu-latest
        needs: lint

        services:
            mysql:
                image: mysql:8.0
                env:
                    MYSQL_DATABASE: laravel
                    MYSQL_USER: sail
                    MYSQL_PASSWORD: password
                    MYSQL_ROOT_PASSWORD: password
                ports:
                    - 3306:3306
                options: >-
                    --health-cmd="mysqladmin ping --silent"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=5

        steps:
            - uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build CI Docker image
              run: docker build -f Dockerfile.ci -t laravel-ci .

            - name: Run Tests
              run: |
                  docker run --rm --network host \
                    -e APP_ENV=testing \
                    -e DB_CONNECTION=mysql \
                    -e DB_HOST=127.0.0.1 \
                    -e DB_PORT=3306 \
                    -e DB_DATABASE=laravel \
                    -e DB_USERNAME=sail \
                    -e DB_PASSWORD=password \
                    laravel-ci sh -c "
                      cp .env.example .env &&
                      php artisan key:generate &&
                      php artisan migrate --force 
                    "

    # =====================
    # 3. BUILD (Optional)
    # =====================
    build:
        runs-on: ubuntu-latest
        needs: test

        steps:
            - uses: actions/checkout@v4

            - name: Build Production Docker Image
              run: docker build -t laravel-app .
